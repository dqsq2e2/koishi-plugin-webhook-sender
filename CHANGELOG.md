# 更新日志

## v3.4.1

`2025-05-6`

### 功能改进

- 🔢 **消息索引显示修复**
  - 修复了查询特定索引消息时序号显示不正确的问题
  - 优化了范围查询消息的显示格式，现在显示的序号与请求的索引一致
  - 例如，使用 `-n 2` 命令现在会显示 `[2]` 而不是 `[1]`

- 🛡️ **权限控制增强**
  - 对未开启 `storeAllMessages` 的路径，完全禁止使用 `-n` 或 `-d` 选项
  - 改进了选项检测逻辑，提供更加精确的用户操作限制
  - 统一了错误提示信息，清晰指导用户正确配置

### 体验优化

- 📊 **消息展示格式优化**
  - 重构消息格式化逻辑，更加智能地处理时间戳显示
  - 规范化单条和多条消息的显示格式
  - 简化了默认查询最新消息的输出，不再显示多余的信息

- 💻 **指令处理逻辑优化**
  - 改进参数解析，正确处理空参数和默认值
  - 增强命令选项检测机制，减少误判
  - 提高了指令处理的健壮性和响应速度

### 代码质量提升

- 🔧 **类型安全加强**
  - 修复了多处TypeScript类型错误，提高代码质量
  - 增加类型声明，减少隐式any类型使用
  - 优化错误处理逻辑，提供更友好的错误提示

- 📝 **代码可维护性优化**
  - 重构消息处理逻辑，简化复杂的条件判断
  - 增加详细的代码注释，提高可读性
  - 统一代码风格，便于后续扩展和维护

## v3.3.1

`2025-05-6`

### 功能改进

- 🔍 **查询功能增强**
  - 新增 `-n 2-5` 范围查询格式，支持查询指定范围内的多条消息
  - 智能显示时间戳：只在使用 `-n` 参数（非默认值）或范围查询时显示时间戳
  - 优化了多条消息的显示格式，提高可读性

### 开发体验改进

- 🛠️ **代码质量提升**
  - 优化了消息处理逻辑，简化了条件判断
  - 改进了代码注释，增加了功能说明
  - 增强了时间戳和索引显示的一致性

## v3.3.0

`2025-05-6`

### 新增功能

- ✨ **多条消息存储功能**
  - 新增 `storeAllMessages` 配置选项，控制是否保存所有接收到的消息历史
  - 新增 `maxStoredMessages` 配置选项，限制最大存储消息数量
  - 默认情况下，每个Webhook路径可以存储多达50条历史消息
  - 支持查询指定索引的历史消息

- 🔍 **消息查询增强**
  - 新增 `-n, --number` 命令选项，可查询指定索引的消息
  - 支持查询全部消息历史（使用 `-n all` 或 `-n a`）
  - 默认仍然查询最新消息（索引1）

- 🗑️ **消息管理功能**
  - 新增 `-d, --delete` 命令选项，支持灵活的消息删除功能
  - 支持删除单条消息（如 `-d 3`）
  - 支持删除指定范围的消息（如 `-d 2-5`）
  - 支持删除所有消息（`-d all` 或 `-d a`）
  - 支持删除最新消息以外的所有消息（`-d old` 或 `-d o`）

### 性能优化

- ⚡ **存储性能优化**
  - 优化消息存储机制，减少内存占用
  - 改进持久化存储结构，支持高效的消息历史管理
  - 自动清理过期消息，防止存储空间无限增长
  - 当消息数量超过 `maxStoredMessages` 限制时，自动移除最旧的消息
  - 保证内存使用量稳定，适合长期运行的机器人

### 用户体验改进

- 📋 **消息展示优化**
  - 改进多条消息的展示格式，包含时间戳和内容摘要
  - 对于长消息自动截断，防止消息过长影响阅读
  - 按照从新到旧的顺序排列消息，方便查看最新信息

- 📚 **文档完善**
  - 更新配置示例，添加新功能说明
  - 补充命令选项使用说明
  - 添加教程视频链接，帮助用户快速上手

## v3.2.0

`2025-05-5`

### 新增功能

- ✨ **即时转发控制功能**
  - 新增 `instantForward` 配置选项，可控制是否立即转发webhook消息
  - 默认为 `true`，设置为 `false` 时仅保存消息而不转发
  - 可通过指令单独查询和转发已保存的消息
  - 为高频率webhook提供更好的消息管理

## v3.1.0

`2025-05-05`

### 重大更新

- ✨ **消息持久化存储功能**
  - 新增 `persistMessages` 配置选项，支持将最新消息持久化存储到磁盘
  - 支持 `persistPath` 全局配置，用于指定持久化存储路径
  - 重启机器人后自动从磁盘加载之前保存的消息
  - 防止服务器重启后消息丢失

### 代码优化

- 🛠️ **程序健壮性提升**
  - 改进错误处理机制，提高异常情况下的稳定性
  - 优化文件存取逻辑，防止路径特殊字符问题
  - 完善日志记录，提供更详细的操作信息

## v3.0.0

`2025-05-05`

### 重大更新

- ✨ **标准指令系统支持**
  - 使用 `ctx.command` 替代原来的中间件方式注册指令
  - 所有自定义指令现在都能在指令列表中显示
  - 添加了详细的指令描述和使用帮助
  - 支持使用 `help 命令名` 获取帮助信息

- 🔄 **指令选项支持**
  - 新增 `-p, --path <path>` 选项，用于指定要查询的Webhook路径
    - 例如：`github -p /gitlab` 可查询 `/gitlab` 路径的最新消息
  - 支持 `-h, --help` 选项显示帮助信息
    - 例如：`github -h` 显示指令帮助

- 🌐 **平台特定指令**
  - 新增 `webhook-latest [path]` 命令，只对onebot平台可用
  - 不带参数时列出所有可用的Webhook路径
    - 例如：`webhook-latest` 显示所有可用路径
  - 带路径参数时查询指定路径的最新消息
    - 例如：`webhook-latest /github` 查询GitHub路径的最新消息

## v2.2.4

`2025-05-04`

### 代码优化

- 🛠️ **消息处理逻辑优化**
  - 优化会话ID识别逻辑，更准确地区分群聊和私聊
  - 改进机器人实例获取方式，更安全地处理跨平台消息
  - 修复了路径参数可能为undefined的问题

- 📝 **日志系统改进**
  - 添加更详细的指令执行日志
  - 完善错误处理和提示信息
  - 优化配置读取日志

## v2.2.1

`2025-05-04`

### 改进

- 🐛 修复了启用插件时的"插件已在运行且不可重用"错误
- 🛡️ 增强了类型安全检查，提高了代码健壮性

## v2.2.0

`2025-05-03`

### 功能改进

- ✨ 将自定义指令注册为标准Koishi指令
- 🔄 添加commands依赖，使指令能被@koishijs/plugin-commands管理
- 📋 支持指令描述和帮助信息
- 🔖 支持通过`-p`参数指定路径
- 🧰 完善指令参数和选项处理

## v2.1.0

`2025-05-03`

### 功能改进

- ✨ 完善指令响应系统
- 🔒 指令响应现在严格限制为只回复发送指令的用户或群
- 📝 增加详细的指令处理日志
- 🧩 优化消息会话ID识别逻辑

## v2.0.0

`2025-05-02`

### 新增功能

- ✨ 添加保存最新消息功能
- ✨ 添加通过自定义指令获取最新消息功能
- 🔧 完善类型定义和错误处理
- 📝 更新文档和示例

### 改进

- ♻️ 代码结构优化
- 🐛 修复了配置头检查的问题
- 🚀 改进消息处理逻辑
- 🔍 增强日志输出

## v1.0.0

`2025-05-01`

### 新增功能

- ✨ 基础 webhook 监听功能
- ✨ 支持 GET/POST 请求处理
- ✨ 支持请求头验证
- ✨ 支持消息模板替换
- ✨ 支持多平台机器人消息发送 